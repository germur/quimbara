---
import { getEntry } from 'astro:content'

import { Button } from 'astro-pure/user'
import { getFightingStyle, getFinishRate, getWinStreak, isUndefeated } from '@/utils/fighter-stats'

interface Props {
  fighterId: number
  historicalEvents?: {
    year: string
    title: string
    description: string
    type: 'championship' | 'suspension' | 'fight' | 'return'
  }[]
}

interface Fight {
  id: number
  status: { short: string; long: string }
  fighters: {
    first: { id: number; winner: boolean; name: string }
    second: { id: number; winner: boolean; name: string }
  }
  date: string
  slug: string
  league: { name: string; logo: string }
}

interface FighterProfile {
  name: string
  nickname: string
  photo: string
  height: string
  weight: string
  reach: string
  stance: string
  birth: { date: string; country: string }
  team: { name: string }
  division: string
}

interface FighterRecords {
  total: { win: number; loss: number; draw: number }
  ko: { win: number; loss: number }
  sub: { win: number; loss: number }
  dec?: { win: number; loss: number }
}

const { fighterId, historicalEvents = [] } = Astro.props

let fighter: FighterProfile | null = null
let records: FighterRecords | null = null
let recentFights: Fight[] = []
let nextFight: Fight | null = null

try {
  const entry = await getEntry('fighterData', fighterId.toString())

  if (!entry || !entry.data) {
    console.error(`[FighterProfile] No entry found for fighterId: ${fighterId}`)
  } else {
    const cacheData = entry.data
    const rawProfile = cacheData?.profile as any

    if (!rawProfile || typeof rawProfile !== 'object') {
      console.error(`[FighterProfile] Invalid or missing profile for fighterId: ${fighterId}`, {
        hasProfile: !!rawProfile,
        type: typeof rawProfile
      })
    } else {
      // Map raw data to interface, handling missing fields safely
      fighter = {
        name: rawProfile.name || 'Unknown Fighter',
        nickname: rawProfile.nickname || '',
        photo: rawProfile.photo || '/images/fighter-placeholder.png',
        height: rawProfile.height || 'N/A',
        weight: rawProfile.weight || 'N/A',
        reach: rawProfile.reach || 'N/A',
        stance: rawProfile.stance || 'N/A',
        birth: {
          date: rawProfile.birth_date || null,
          country: rawProfile.birth_country || null
        },
        team: rawProfile.team || { name: 'Independent' },
        division: rawProfile.category || 'UFC'
      }
    }

    const rawRecords = cacheData?.records
    if (rawRecords && typeof rawRecords === 'object' && rawRecords.total) {
      records = rawRecords as FighterRecords

      // Calculate decision wins/losses if missing
      const decWins = records.total.win - (records.ko?.win || 0) - (records.sub?.win || 0)
      const decLoss = records.total.loss - (records.ko?.loss || 0) - (records.sub?.loss || 0)
      records.dec = { win: decWins, loss: decLoss }
    }

    recentFights = (cacheData?.fights || []) as Fight[]

    // Find next fight (scheduled/not finished)
    nextFight = recentFights.find((f) => f.status.short === 'NS') || null
  }
} catch (e) {
  console.error(`[FighterProfile] Error loading data for ${fighterId}:`, e)
}

// Calculate derived stats
const winStreak = fighter && recentFights.length ? getWinStreak(recentFights, fighterId) : 0
const undefeated = records ? isUndefeated(records) : false
const fightingStyle = records
  ? getFightingStyle(records)
  : { primary: 'balanced', label: 'All-Rounder' }
const finishStats = records ? getFinishRate(records) : { finishRate: 0, koRate: 0, subRate: 0 }

// CRITICAL: If no fighter data, stop rendering now
if (!fighter) {
  // Return early - Astro will render the error fallback below
  console.warn(
    `[FighterProfile] Fighter data is null for fighterId: ${fighterId}. Showing error message.`
  )
}

// Process Timeline Events
const recentEvents = recentFights
  .filter((f: Fight) => f.status.short === 'FT') // Only finished fights
  .map((f: Fight) => {
    const isWinner =
      (f.fighters.first.id === fighterId && f.fighters.first.winner) ||
      (f.fighters.second.id === fighterId && f.fighters.second.winner)
    const opponent =
      f.fighters.first.id === fighterId ? f.fighters.second.name : f.fighters.first.name

    return {
      year: new Date(f.date).getFullYear().toString(),
      title: isWinner ? `Victoria vs ${opponent}` : `Derrota vs ${opponent}`,
      description: `${f.slug}. ${isWinner ? 'Gan贸' : 'Perdi贸'} el combate.`,
      type: 'fight' as const,
      dateObj: new Date(f.date)
    }
  })

const allEvents = [
  ...historicalEvents.map((e) => ({ ...e, dateObj: new Date(parseInt(e.year), 0) })),
  ...recentEvents
].sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime())

// Helper for age calculation
function calculateAge(birthDate: string) {
  if (!birthDate) return 'N/A'
  const today = new Date()
  const birth = new Date(birthDate)
  let age = today.getFullYear() - birth.getFullYear()
  const m = today.getMonth() - birth.getMonth()
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
    age--
  }
  return age
}

// Schema.org JSON-LD for Athlete
const athleteSchema = fighter
  ? {
      '@context': 'https://schema.org',
      '@type': 'Athlete',
      name: fighter.name,
      alternateName: fighter.nickname,
      image: fighter.photo,
      height: fighter.height,
      weight: fighter.weight,
      nationality: fighter.birth?.country,
      birthDate: fighter.birth?.date,
      sport: 'Mixed Martial Arts',
      affiliation: {
        '@type': 'SportsOrganization',
        name: 'UFC'
      },
      memberOf: {
        '@type': 'SportsTeam',
        name: fighter.team?.name || 'Independent'
      },
      jobTitle: `${fighter.division || 'UFC'} Fighter`,
      description: `${fighter.name} (${fighter.nickname}) es un peleador profesional de artes marciales mixtas con r茅cord de ${records && records.total ? records.total.win : 0}-${records && records.total ? records.total.loss : 0}-${records && records.total ? records.total.draw : 0}.`
    }
  : null
---

{athleteSchema && <script type='application/ld+json' set:html={JSON.stringify(athleteSchema)} />}

{
  !fighter ? (
    <div class='min-h-screen flex items-center justify-center'>
      <div class='text-center'>
        <h1 class='text-4xl font-bold text-quimbara-purple mb-4'>Peleador no encontrado</h1>
        <p class='text-quimbara-purple/70'>
          Los datos de este peleador no est谩n disponibles en este momento.
        </p>
        <a
          href='/fighters'
          class='mt-6 inline-block px-6 py-3 bg-quimbara-magenta text-white rounded-xl hover:bg-[#D63384] transition-colors'
        >
          Ver todos los peleadores
        </a>
      </div>
    </div>
  ) : (
    <div class='fighter-profile-container space-y-12'>
      {/* 1. HERO SECTION - LIGHT/CLEAN THEME */}
      <section class='relative rounded-3xl overflow-hidden border border-border shadow-lg bg-white'>
        {/* Background Gradient */}
        <div class='absolute inset-0 bg-gradient-to-br from-quimbara-cream via-white to-quimbara-pink/10 z-0' />

        <div class='relative z-10 p-8 md:p-12 lg:p-16'>
          <div class='grid grid-cols-1 lg:grid-cols-[auto_1fr] gap-8 lg:gap-12 items-center w-full max-w-[1920px] mx-auto'>
            {/* Fighter Image */}
            <div class='relative shrink-0 mx-auto lg:mx-0'>
              <div class='w-48 h-48 md:w-64 md:h-64 lg:w-80 lg:h-80 rounded-full overflow-hidden border-4 border-quimbara-magenta shadow-2xl shadow-quimbara-magenta/20 bg-white relative z-10'>
                <img src={fighter.photo} alt={fighter.name} class='w-full h-full object-cover' />
              </div>
              {/* Rank Badge */}
              {/* Dynamic Badges */}
              <div class='absolute -bottom-4 -right-4 flex flex-col gap-2 items-end z-20'>
                {undefeated && (
                  <div class='bg-quimbara-magenta text-white font-bold text-xs px-3 py-1 rounded-full border-2 border-white shadow-lg uppercase tracking-wider'>
                    Invicto
                  </div>
                )}
                {winStreak >= 3 && (
                  <div class='bg-green-500 text-white font-bold text-xs px-3 py-1 rounded-full border-2 border-white shadow-lg uppercase tracking-wider'>
                    {winStreak} Wins Streak
                  </div>
                )}
              </div>
            </div>

            {/* Info - Left aligned for better readability */}
            <div class='flex-1 space-y-6 text-center lg:text-left min-w-0'>
              <div>
                {/* DEFINITIVE FIX: Fluid typography using clamp() to adapt to any width + break-words for safety */}
                <h1 class='text-[clamp(2.5rem,5vw,4.5rem)] font-heading font-bold text-quimbara-purple leading-[1.1] mb-3 uppercase tracking-tight break-words'>
                  {fighter.name}
                </h1>
                {fighter.nickname && (
                  <p class='text-[clamp(1.5rem,3vw,2.5rem)] text-quimbara-magenta font-heading font-bold italic tracking-wide break-words'>
                    "{fighter.nickname}"
                  </p>
                )}
              </div>

              <div class='flex flex-wrap justify-center lg:justify-start gap-4 md:gap-6 text-quimbara-purple/70 font-medium text-base md:text-lg'>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span>{' '}
                  {fighter.division || 'UFC Fighter'}
                </span>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span>{' '}
                  {fighter.birth?.country || 'N/A'}
                </span>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span>{' '}
                  <span class='truncate max-w-[200px]'>{fighter.team?.name || 'Independent'}</span>
                </span>
              </div>

              {/* Record (Big Stats) */}
              <div class='bg-quimbara-cream rounded-2xl p-4 md:p-6 inline-block w-full lg:w-auto'>
                <div class='text-quimbara-purple/60 text-xs md:text-sm font-bold uppercase tracking-widest mb-2'>
                  R茅cord Profesional
                </div>
                {/* Fluid typography for record numbers too */}
                <div class='flex items-baseline justify-center lg:justify-start gap-1 text-[clamp(3rem,6vw,5rem)] font-heading font-bold text-quimbara-magenta leading-none'>
                  <span>{records && records.total ? records.total.win : 0}</span>
                  <span class='text-quimbara-purple/40'>-</span>
                  <span>{records && records.total ? records.total.loss : 0}</span>
                  <span class='text-quimbara-purple/40 text-[clamp(2rem,4vw,3rem)]'>
                    -{records && records.total ? records.total.draw : 0}
                  </span>
                </div>
              </div>
              </div>
              
              {/* Style Analysis Badge */}
              <div class="mt-6 flex flex-wrap gap-3 justify-center lg:justify-start">
                <div class="bg-quimbara-purple/5 px-4 py-2 rounded-lg border border-quimbara-purple/10">
                  <span class="text-xs uppercase font-bold text-quimbara-purple/60 block">Estilo</span>
                  <span class="font-bold text-quimbara-purple">{fightingStyle.label}</span>
                </div>
                <div class="bg-quimbara-purple/5 px-4 py-2 rounded-lg border border-quimbara-purple/10">
                  <span class="text-xs uppercase font-bold text-quimbara-purple/60 block">Finalizaci贸n</span>
                  <span class="font-bold text-quimbara-purple">{finishStats.finishRate}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* 2. QUICK ANSWER BOX (SEO) */}
      <section class='bg-white border border-border p-8 rounded-3xl border-l-4 border-l-quimbara-magenta shadow-sm'>
        <h2 class='text-2xl font-bold text-quimbara-purple mb-6 flex items-center gap-3'>
          <svg
            class='w-6 h-6 text-quimbara-magenta'
            fill='none'
            stroke='currentColor'
            viewBox='0 0 24 24'
          >
            <path
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
            />
          </svg>
          Datos Clave: {fighter.name}
        </h2>
        <div class='grid grid-cols-2 md:grid-cols-4 gap-8'>
          {fighter.birth?.date && (
            <div>
              <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
                Edad
              </span>
              <span class='text-2xl font-bold text-quimbara-magenta'>
                {calculateAge(fighter.birth?.date || '')} a帽os
              </span>
            </div>
          )}
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Altura
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.height}</span>
          </div>
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Alcance
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.reach}</span>
          </div>
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Estilo
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.stance}</span>
          </div>
        </div>
      </section>

      {/* 2.5 FIGHT TIMELINE */}
      {recentFights.filter(f => f.status.short === 'FT').length > 0 && (
        <section class="bg-white border border-border p-8 rounded-3xl shadow-sm">
          <h2 class="text-xl font-bold text-quimbara-purple mb-6 flex items-center gap-2">
            <span></span> Racha Reciente
          </h2>
          <div class="flex items-center gap-4 overflow-x-auto pb-4 custom-scrollbar">
            {recentFights.filter(f => f.status.short === 'FT').slice(0, 10).map(fight => {
               const isWinner = (fight.fighters.first.id === fighterId && fight.fighters.first.winner) || 
                                (fight.fighters.second.id === fighterId && fight.fighters.second.winner);
               const opponent = fight.fighters.first.id === fighterId ? fight.fighters.second.name : fight.fighters.first.name;
               
               return (
                 <div class="flex flex-col items-center min-w-[100px] relative group">
                   <div class={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold mb-2 shadow-md transition-transform group-hover:scale-110 ${isWinner ? 'bg-green-500' : 'bg-red-500'}`}>
                     {isWinner ? 'W' : 'L'}
                   </div>
                   <div class="text-xs text-center font-bold text-quimbara-purple truncate w-full px-1" title={opponent}>{opponent}</div>
                   <div class="text-[10px] text-quimbara-purple/60">{new Date(fight.date).toLocaleDateString('es-ES', { month: 'short', year: '2-digit' })}</div>
                   
                   {/* Tooltip */}
                   <div class="absolute bottom-full mb-2 hidden group-hover:block bg-quimbara-purple text-white text-xs p-2 rounded whitespace-nowrap z-10">
                      {isWinner ? 'Victoria' : 'Derrota'} vs {opponent}
                   </div>
                 </div>
               )
            })}
          </div>
        </section>
      )}

      {/* 3. THE BODY (Analysis & Stats) */}
      <div class='grid lg:grid-cols-3 gap-8'>
        {/* Left Col: Detailed Stats */}
        <div class='lg:col-span-1 space-y-8'>
          {/* Stats Card */}
          <div class='bg-white rounded-3xl shadow-xl border border-quimbara-purple/5 p-6 overflow-hidden relative'>
            <div class='absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-quimbara-magenta to-quimbara-purple' />
            <h3 class='text-xl font-heading font-bold text-quimbara-purple mb-6 flex items-center gap-2'>
              <span class='text-quimbara-magenta'></span> Desglose de Victorias
            </h3>

            <div class='space-y-6'>
              {/* KO/TKO */}
              <div>
                <div class='flex justify-between items-end mb-2'>
                  <span class='font-bold text-quimbara-purple'>KO/TKO</span>
                  <span class='text-2xl font-bold text-quimbara-magenta'>{records?.ko.win}</span>
                </div>
                <div class='w-full h-3 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                  <div
                    class='h-full bg-[#FF6D00] rounded-full'
                    style={`width: ${((records?.ko.win || 0) / (records?.total.win || 1)) * 100}%`}
                  />
                </div>
              </div>

              {/* Submission */}
              <div>
                <div class='flex justify-between items-end mb-2'>
                  <span class='font-bold text-quimbara-purple'>Sumisi贸n</span>
                  <span class='text-2xl font-bold text-quimbara-magenta'>{records?.sub.win}</span>
                </div>
                <div class='w-full h-3 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                  <div
                    class='h-full bg-quimbara-purple/60 rounded-full'
                    style={`width: ${((records?.sub.win || 0) / (records?.total.win || 1)) * 100}%`}
                  />
                </div>
              </div>

              {/* Decision */}
              <div>
                <div class='flex justify-between items-end mb-2'>
                  <span class='font-bold text-quimbara-purple'>Decisi贸n</span>
                  <span class='text-2xl font-bold text-quimbara-magenta'>{records?.dec?.win}</span>
                </div>
                <div class='w-full h-3 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                  <div
                    class='h-full bg-green-500 rounded-full'
                    style={`width: ${((records?.dec?.win || 0) / (records?.total.win || 1)) * 100}%`}
                  />
                </div>
              </div>
            </div>
          </div>

          {nextFight && (
            <div class='bg-white rounded-3xl shadow-xl border border-quimbara-pink/30 p-6 relative overflow-hidden'>
              <div class='absolute top-0 left-0 w-full h-1 bg-quimbara-pink' />
              <h3 class='text-xl font-heading font-bold text-quimbara-pink mb-4 flex items-center gap-2'>
                <span></span> Pr贸ximo Combate
              </h3>
              <div class='text-center bg-quimbara-cream/50 rounded-2xl p-4 border border-quimbara-purple/5'>
                <div class='text-sm text-quimbara-purple/70 mb-2 font-bold uppercase tracking-wider'>
                  {new Date(nextFight.date).toLocaleDateString(undefined, {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </div>
                <div class='text-3xl font-bold text-quimbara-magenta mb-2 leading-tight'>
                  vs. <br />
                  {nextFight.fighters.first.id === fighterId
                    ? nextFight.fighters.second.name
                    : nextFight.fighters.first.name}
                </div>
                <div class='inline-block bg-quimbara-magenta text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest mt-2'>
                  {nextFight?.league?.name || nextFight.slug || 'UFC'}
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Right Col: Timeline */}
        <div class='lg:col-span-2'>
          <div class='bg-white rounded-3xl shadow-xl border border-quimbara-purple/5 p-8 relative'>
            <div class='absolute top-0 left-0 w-full h-2 bg-quimbara-purple' />
            <h3 class='text-2xl font-heading font-bold text-quimbara-purple mb-8 flex items-center gap-3'>
              <span class='text-quimbara-magenta'></span> Historial de Combates
            </h3>
            <div class='relative border-l-4 border-quimbara-purple/10 ml-3 space-y-8'>
              {allEvents.map((event) => (
                <div class='ml-8 relative group'>
                  <div
                    class={`absolute -left-[42px] w-6 h-6 rounded-full border-4 border-white shadow-sm ${
                      event.title.includes('Victoria')
                        ? 'bg-green-500'
                        : event.title.includes('Derrota')
                          ? 'bg-[#FF6D00]'
                          : event.type === 'championship'
                            ? 'bg-quimbara-magenta'
                            : 'bg-quimbara-purple/30'
                    } group-hover:scale-125 transition-transform duration-300 z-10`}
                  />

                  <div class='bg-quimbara-cream/30 p-6 rounded-2xl border border-quimbara-purple/5 hover:bg-white hover:shadow-md transition-all duration-300'>
                    <div class='flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 gap-2'>
                      <h4
                        class={`text-lg font-bold ${event.title.includes('Victoria') ? 'text-green-600' : event.title.includes('Derrota') ? 'text-[#FF6D00]' : 'text-quimbara-purple'}`}
                      >
                        {event.title}
                      </h4>
                      <span class='text-xs font-bold bg-white px-2 py-1 rounded-md border border-quimbara-purple/10 text-quimbara-purple/60 shadow-sm'>
                        {event.year}
                      </span>
                    </div>
                    <p class='text-quimbara-purple/80 text-sm leading-relaxed font-medium'>
                      {event.description}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
