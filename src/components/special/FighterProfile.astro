---
import { getEntry } from 'astro:content'

import { Button } from 'astro-pure/user'

interface Props {
  fighterId: number
  historicalEvents?: {
    year: string
    title: string
    description: string
    type: 'championship' | 'suspension' | 'fight' | 'return'
  }[]
}

interface Fight {
  status: { short: string; long: string }
  fighters: {
    first: { id: number; winner: boolean; name: string }
    second: { id: number; winner: boolean; name: string }
  }
  date: string
  slug: string
  league: { name: string; logo: string }
}

interface FighterProfile {
  name: string
  nickname: string
  photo: string
  height: string
  weight: string
  reach: string
  stance: string
  birth: { date: string; country: string }
  team: { name: string }
  division: string
}

interface FighterRecords {
  total: { win: number; loss: number; draw: number }
  ko: { win: number; loss: number }
  sub: { win: number; loss: number }
  dec?: { win: number; loss: number }
}

const { fighterId, historicalEvents = [] } = Astro.props

let fighter: FighterProfile | null = null
let records: FighterRecords | null = null
let recentFights: Fight[] = []
let nextFight: Fight | null = null

try {
  const entry = await getEntry('fighterData', fighterId.toString())

  if (!entry || !entry.data) {
    console.error(`[FighterProfile] No entry found for fighterId: ${fighterId}`)
  } else {
    const cacheData = entry.data
    const rawProfile = cacheData?.profile as any

    if (!rawProfile || typeof rawProfile !== 'object') {
      console.error(`[FighterProfile] Invalid or missing profile for fighterId: ${fighterId}`, {
        hasProfile: !!rawProfile,
        type: typeof rawProfile
      })
    } else {
      // Map raw data to interface, handling missing fields safely
      fighter = {
        name: rawProfile.name || 'Unknown Fighter',
        nickname: rawProfile.nickname || '',
        photo: rawProfile.photo || '/images/fighter-placeholder.png',
        height: rawProfile.height || 'N/A',
        weight: rawProfile.weight || 'N/A',
        reach: rawProfile.reach || 'N/A',
        stance: rawProfile.stance || 'N/A',
        birth: {
          date: rawProfile.birth_date || null,
          country: rawProfile.birth_country || null
        },
        team: rawProfile.team || { name: 'Independent' },
        division: rawProfile.category || 'UFC'
      }
    }

    const rawRecords = cacheData?.records
    if (rawRecords && typeof rawRecords === 'object' && rawRecords.total) {
      records = rawRecords as FighterRecords

      // Calculate decision wins/losses if missing
      const decWins = records.total.win - (records.ko?.win || 0) - (records.sub?.win || 0)
      const decLoss = records.total.loss - (records.ko?.loss || 0) - (records.sub?.loss || 0)
      records.dec = { win: decWins, loss: decLoss }
    }

    recentFights = (cacheData?.fights || []) as Fight[]

    // Find next fight (scheduled/not finished)
    nextFight = recentFights.find((f) => f.status.short === 'NS') || null
  }
} catch (e) {
  console.error(`Error reading fighter data for fighterId ${fighterId}:`, e)
}

// CRITICAL: If no fighter data, stop rendering now
if (!fighter) {
  // Return early - Astro will render the error fallback below
  console.warn(
    `[FighterProfile] Fighter data is null for fighterId: ${fighterId}. Showing error message.`
  )
}

// Process Timeline Events
const recentEvents = recentFights
  .filter((f: Fight) => f.status.short === 'FT') // Only finished fights
  .map((f: Fight) => {
    const isWinner =
      (f.fighters.first.id === fighterId && f.fighters.first.winner) ||
      (f.fighters.second.id === fighterId && f.fighters.second.winner)
    const opponent =
      f.fighters.first.id === fighterId ? f.fighters.second.name : f.fighters.first.name

    return {
      year: new Date(f.date).getFullYear().toString(),
      title: isWinner ? `Victoria vs ${opponent}` : `Derrota vs ${opponent}`,
      description: `${f.slug}. ${isWinner ? 'Gan贸' : 'Perdi贸'} el combate.`,
      type: 'fight' as const,
      dateObj: new Date(f.date)
    }
  })

const allEvents = [
  ...historicalEvents.map((e) => ({ ...e, dateObj: new Date(parseInt(e.year), 0) })),
  ...recentEvents
].sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime())

// Helper for age calculation
function calculateAge(birthDate: string) {
  if (!birthDate) return 'N/A'
  const today = new Date()
  const birth = new Date(birthDate)
  let age = today.getFullYear() - birth.getFullYear()
  const m = today.getMonth() - birth.getMonth()
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
    age--
  }
  return age
}

// Schema.org JSON-LD for Athlete
const athleteSchema = fighter
  ? {
      '@context': 'https://schema.org',
      '@type': 'Person',
      name: fighter.name,
      alternateName: fighter.nickname,
      image: fighter.photo,
      height: fighter.height,
      weight: fighter.weight,
      nationality: fighter.birth?.country,
      birthDate: fighter.birth?.date,
      affiliation: {
        '@type': 'SportsOrganization',
        name: 'UFC'
      },
      memberOf: {
        '@type': 'SportsTeam',
        name: fighter.team?.name || 'Independent'
      },
      jobTitle: `${fighter.division || 'UFC'} Fighter`,
      description: `${fighter.name} (${fighter.nickname}) es un peleador profesional de artes marciales mixtas con r茅cord de ${records && records.total ? records.total.win : 0}-${records && records.total ? records.total.loss : 0}-${records && records.total ? records.total.draw : 0}.`
    }
  : null
---

{athleteSchema && <script type='application/ld+json' set:html={JSON.stringify(athleteSchema)} />}

{
  !fighter ? (
    <div class='min-h-screen flex items-center justify-center'>
      <div class='text-center'>
        <h1 class='text-4xl font-bold text-quimbara-purple mb-4'>Peleador no encontrado</h1>
        <p class='text-quimbara-purple/70'>
          Los datos de este peleador no est谩n disponibles en este momento.
        </p>
        <a
          href='/fighters'
          class='mt-6 inline-block px-6 py-3 bg-quimbara-magenta text-white rounded-xl hover:bg-[#D63384] transition-colors'
        >
          Ver todos los peleadores
        </a>
      </div>
    </div>
  ) : (
    <div class='fighter-profile-container space-y-12'>
      {/* 1. HERO SECTION - LIGHT/CLEAN THEME */}
      <section class='relative rounded-3xl overflow-hidden border border-border shadow-lg bg-white'>
        {/* Background Gradient */}
        <div class='absolute inset-0 bg-gradient-to-br from-quimbara-cream via-white to-quimbara-pink/10 z-0' />

        <div class='relative z-10 p-8 md:p-12 lg:p-16'>
          <div class='grid grid-cols-1 lg:grid-cols-[auto_1fr] gap-8 lg:gap-12 items-center max-w-7xl mx-auto'>
            {/* Fighter Image */}
            <div class='relative shrink-0 mx-auto lg:mx-0'>
              <div class='w-48 h-48 md:w-64 md:h-64 lg:w-80 lg:h-80 rounded-full overflow-hidden border-4 border-quimbara-magenta shadow-2xl shadow-[#E83C91]/20 bg-white relative z-10'>
                <img src={fighter.photo} alt={fighter.name} class='w-full h-full object-cover' />
              </div>
              {/* Rank Badge */}
              <div class='absolute -bottom-4 -right-4 bg-quimbara-magenta text-white font-black text-2xl w-16 h-16 flex items-center justify-center rounded-full border-4 border-white shadow-lg z-20'>
                C
              </div>
            </div>

            {/* Info - Left aligned for better readability */}
            <div class='flex-1 space-y-6 text-center lg:text-left min-w-0'>
              <div>
                <h1 class='text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl font-heading font-bold text-quimbara-purple leading-none mb-3 uppercase tracking-tight break-words'>
                  {fighter.name}
                </h1>
                {fighter.nickname && (
                  <p class='text-2xl sm:text-3xl md:text-4xl text-quimbara-magenta font-heading font-bold italic tracking-wide break-words'>
                    "{fighter.nickname}"
                  </p>
                )}
              </div>

              <div class='flex flex-wrap justify-center lg:justify-start gap-4 md:gap-6 text-quimbara-purple/70 font-medium text-base md:text-lg'>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span>{' '}
                  {fighter.division || 'UFC Fighter'}
                </span>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span> {fighter.birth?.country || 'N/A'}
                </span>
                <span class='flex items-center gap-2 whitespace-nowrap'>
                  <span class='text-quimbara-magenta text-2xl'></span>{' '}
                  <span class='truncate max-w-[200px]'>{fighter.team?.name || 'Independent'}</span>
                </span>
              </div>

              {/* Record (Big Stats) */}
              <div class='bg-quimbara-cream rounded-2xl p-4 md:p-6 inline-block w-full lg:w-auto'>
                <div class='text-quimbara-purple/60 text-xs md:text-sm font-bold uppercase tracking-widest mb-2'>
                  R茅cord Profesional
                </div>
                <div class='text-5xl sm:text-6xl md:text-7xl lg:text-8xl xl:text-9xl font-heading font-bold text-quimbara-magenta leading-none'>
                  {records && records.total ? records.total.win : 0}
                  <span class='text-quimbara-purple/40'>-</span>
                  {records && records.total ? records.total.loss : 0}
                  <span class='text-quimbara-purple/40 text-3xl sm:text-4xl md:text-5xl'>
                    -{records && records.total ? records.total.draw : 0}
                  </span>
                </div>
              </div>
              <div class='flex justify-center gap-6 mt-4 text-base font-mono text-quimbara-purple/70'>
                <span>
                  <span class='text-quimbara-magenta font-bold'>
                    {records && records.ko ? records.ko.win : 0}
                  </span>{' '}
                  KO
                </span>
                <span>
                  <span class='text-quimbara-magenta font-bold'>
                    {records && records.sub ? records.sub.win : 0}
                  </span>{' '}
                  SUB
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* 2. QUICK ANSWER BOX (SEO) */}
      <section class='bg-white border border-border p-8 rounded-3xl border-l-4 border-l-[#E83C91] shadow-sm'>
        <h2 class='text-2xl font-bold text-quimbara-purple mb-6 flex items-center gap-3'>
          <svg class='w-6 h-6 text-quimbara-magenta' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path
              stroke-linecap='round'
              stroke-linejoin='round'
              stroke-width='2'
              d='M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
            />
          </svg>
          Datos Clave: {fighter.name}
        </h2>
        <div class='grid grid-cols-2 md:grid-cols-4 gap-8'>
          {fighter.birth?.date && (
            <div>
              <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
                Edad
              </span>
              <span class='text-2xl font-bold text-quimbara-magenta'>
                {calculateAge(fighter.birth?.date || '')} a帽os
              </span>
            </div>
          )}
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Altura
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.height}</span>
          </div>
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Alcance
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.reach}</span>
          </div>
          <div>
            <span class='block text-quimbara-purple/60 text-sm uppercase font-bold mb-2 tracking-wider'>
              Estilo
            </span>
            <span class='text-2xl font-bold text-quimbara-magenta'>{fighter.stance}</span>
          </div>
        </div>
      </section>

      {/* 3. THE BODY (Analysis & Stats) */}
      <div class='grid lg:grid-cols-3 gap-8'>
        {/* Left Col: Detailed Stats */}
        <div class='lg:col-span-1 space-y-8'>
          <div class='glass-panel p-6 rounded-xl'>
            <h3 class='text-xl font-heading font-bold text-quimbara-magenta mb-6 border-b border-white/10 pb-2'>
              Desglose de Victorias
            </h3>
            <div class='space-y-4'>
              <div class='flex items-center justify-between'>
                <span class='text-quimbara-purple 400'>KO/TKO</span>
                <div class='flex items-center gap-3'>
                  <div class='w-32 h-2 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                    <div
                      class='h-full bg-[#FF6D00]'
                      style={`width: ${((records?.ko.win || 0) / (records?.total.win || 1)) * 100}%`}
                    />
                  </div>
                  <span class='font-bold text-quimbara-magenta w-6 text-right'>{records?.ko.win}</span>
                </div>
              </div>
              <div class='flex items-center justify-between'>
                <span class='text-quimbara-purple 400'>Sumisi贸n</span>
                <div class='flex items-center gap-3'>
                  <div class='w-32 h-2 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                    <div
                      class='h-full bg-quimbara-purple/10'
                      style={`width: ${((records?.sub.win || 0) / (records?.total.win || 1)) * 100}%`}
                    />
                  </div>
                  <span class='font-bold text-quimbara-magenta w-6 text-right'>{records?.sub.win}</span>
                </div>
              </div>
              <div class='flex items-center justify-between'>
                <span class='text-quimbara-purple 400'>Decisi贸n</span>
                <div class='flex items-center gap-3'>
                  <div class='w-32 h-2 bg-quimbara-purple/5 rounded-full overflow-hidden'>
                    <div
                      class='h-full bg-green-500'
                      style={`width: ${((records?.dec?.win || 0) / (records?.total.win || 1)) * 100}%`}
                    />
                  </div>
                  <span class='font-bold text-quimbara-magenta w-6 text-right'>{records?.dec?.win}</span>
                </div>
              </div>
            </div>
          </div>

          {nextFight && (
            <div class='glass-panel p-6 rounded-xl border border-quimbara-pink/30 bg-quimbara-magenta/5'>
              <h3 class='text-xl font-heading font-bold text-quimbara-pink mb-4'>Pr贸ximo Combate</h3>
              <div class='text-center'>
                <div class='text-sm text-quimbara-purple 400 mb-2'>
                  {new Date(nextFight.date).toLocaleDateString()}
                </div>
                <div class='text-2xl font-bold text-quimbara-magenta mb-2'>
                  vs.{' '}
                  {nextFight.fighters.first.id === fighterId
                    ? nextFight.fighters.second.name
                    : nextFight.fighters.first.name}
                </div>
                <div class='inline-block bg-quimbara-magenta text-black text-xs font-bold px-2 py-1 rounded uppercase'>
                  {nextFight?.league?.name || nextFight.slug || 'UFC'}
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Right Col: Timeline */}
        <div class='lg:col-span-2'>
          <div class='glass-panel p-8 rounded-xl'>
            <h3 class='text-2xl font-heading font-bold text-quimbara-magenta mb-8'>
              Historial de Combates
            </h3>
            <div class='relative border-l-2 border-white/10 ml-3 space-y-8'>
              {allEvents.map((event) => (
                <div class='ml-8 relative group'>
                  <div
                    class={`absolute -left-[41px] w-5 h-5 rounded-full border-4 border-[#0a0a0a] ${
                      event.title.includes('Victoria')
                        ? 'bg-green-500'
                        : event.title.includes('Derrota')
                          ? 'bg-[#FF6D00]'
                          : event.type === 'championship'
                            ? 'bg-quimbara-magenta'
                            : 'bg-quimbara-purple/10'
                    } group-hover:scale-125 transition-transform duration-300`}
                  />

                  <div class='bg-white/5 p-6 rounded-lg border border-white/5 hover:bg-white/10 transition-colors'>
                    <div class='flex justify-between items-start mb-2'>
                      <h4 class='text-lg font-bold text-quimbara-magenta group-hover:text-quimbara-magenta transition-colors'>
                        {event.title}
                      </h4>
                      <span class='text-xs font-mono text-quimbara-purple 500'>{event.year}</span>
                    </div>
                    <p class='text-quimbara-purple 400 text-sm leading-relaxed'>{event.description}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
