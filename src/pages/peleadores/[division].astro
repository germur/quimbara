---
import { getCollection } from 'astro:content'
import championsData from '@/data/champions-generated.json'
import fightersData from '@/data/fighters.json'
import { weightClasses, weightClassMapReverse } from '@/data/weightClasses'

import PageLayout from '@/layouts/BaseLayout.astro'
import Breadcrumbs from '@/components/Breadcrumbs.astro'

export async function getStaticPaths() {
  return weightClasses.map((wc) => ({
    params: { division: wc.slug }
  }))
}

const { division: divisionSlug } = Astro.params

// Encontrar info de esta división
const divisionInfo = weightClasses.find((wc) => wc.slug === divisionSlug)
if (!divisionInfo) {
  return Astro.redirect('/404')
}

const division = weightClassMapReverse[divisionSlug]
const divisionEs = divisionInfo.nameEs

// Filtrar peleadores de esta división
interface Fighter {
  id: number
  name: string
  slug: string
  division: string
  rank?: string
  record?: string
}

const divisionFighters = (fightersData as Fighter[]).filter((f) => f.division === division)

// ... (existing code)

// Buscar campeón (Dinámico desde API)
// @ts-ignore
const apiChampion = championsData.champions[divisionInfo.nameEn]
const champion = apiChampion
  ? {
      ...apiChampion,
      record: `${apiChampion.record.win}-${apiChampion.record.loss}-${apiChampion.record.draw}`
    }
  : divisionFighters.find((f) => f.rank === 'C') || divisionFighters[0]

// Top 15 ranking (ordenados por ranking)
const ranking = divisionFighters
  .filter((f) => f.rank && f.rank !== 'NR')
  .sort((a, b) => {
    if (a.rank === 'C') return -1
    if (b.rank === 'C') return 1
    const rankA = parseInt(a.rank || '999') || 999
    const rankB = parseInt(b.rank || '999') || 999
    return rankA - rankB
  })
  .slice(0, 15)

// Noticias relacionadas con esta división
const allPosts = await getCollection('blog')
const relatedNews = allPosts
  .filter((post) =>
    post.data.tags?.some(
      (tag) =>
        tag.toLowerCase().includes(divisionSlug) ||
        tag.toLowerCase().includes(division.toLowerCase())
    )
  )
  .slice(0, 3)

const meta = {
  title: `Peleadores de ${divisionEs} UFC - Ranking y Perfiles Completos | Quimbara`,
  description: `Descubre todos los peleadores de ${divisionEs.toLowerCase()} de UFC. Ranking actualizado, perfiles detallados, estadísticas y análisis de la división ${division}.`
}

// Schema.org
const schemaMarkup = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: `Peleadores de ${divisionEs} UFC`,
  description: meta.description,
  url: `https://quimbara.org/fighters/${divisionSlug}/`
}

// Helper para imagen
const getFighterImg = (id: number) => `https://media.api-sports.io/mma/fighters/${id}.png`
---

<PageLayout {meta}>
  <!-- Schema.org -->
  <script type='application/ld+json' set:html={JSON.stringify(schemaMarkup)} />

  <!-- Breadcrumb -->
  <Breadcrumbs
    path={[
      { title: 'Inicio', link: '/' },
      { title: 'Peleadores', link: '/fighters/' },
      { title: divisionEs, link: `/fighters/${divisionSlug}/` }
    ]}
  />

  <!-- Hero Section - Clean Theme -->
  <section class='py-12 mb-12'>
    <div class='flex flex-col md:flex-row justify-between items-start md:items-end gap-6'>
      <div class='flex-1'>
        <div
          class='inline-block bg-quimbara-magenta/10 text-quimbara-magenta px-4 py-1 rounded-full text-sm font-bold uppercase tracking-wider mb-4 border border-quimbara-magenta/20'
        >
          División Oficial UFC
        </div>
        <h1 class='text-4xl md:text-6xl font-heading font-bold mb-3 text-quimbara-purple'>
          PELEADORES <span class='text-quimbara-magenta'>{divisionEs.toUpperCase()}</span>
        </h1>
        <p class='text-lg text-quimbara-purple/70 max-w-2xl leading-relaxed'>
          {divisionInfo.description}
        </p>
      </div>

      {
        champion && (
          <div class='bg-white border border-border rounded-2xl px-6 py-4 shadow-sm'>
            <div class='flex items-center gap-4'>
              <img
                src={getFighterImg(champion.id)}
                alt={champion.name}
                class='w-16 h-16 rounded-full object-cover bg-quimbara-cream border-2 border-quimbara-magenta'
                loading='lazy'
                onerror="this.src='/images/fighter-placeholder.png'"
              />
              <div>
                <span class='text-xs text-quimbara-purple/60 uppercase font-bold tracking-wider block mb-1'>
                  Campeón Actual
                </span>
                <span class='text-quimbara-magenta font-bold font-heading text-xl'>{champion.name}</span>
              </div>
            </div>
          </div>
        )
      }
    </div>
  </section>

  <div class='grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12'>
    <!-- Main Content: Ranking Table -->
    <div class='lg:col-span-2'>
      <div class='bg-white rounded-3xl overflow-hidden shadow-sm border border-border'>
        <div class='p-6 border-b border-border flex justify-between items-center'>
          <h3 class='font-heading font-bold text-quimbara-purple text-2xl'>Ranking Oficial Top 15</h3>
          <span class='text-xs text-quimbara-purple/50 font-bold uppercase tracking-wider'
            >Actualizado</span
          >
        </div>
        <div class='overflow-x-auto'>
          <table class='w-full text-left'>
            <thead class='bg-quimbara-cream text-quimbara-purple/60 text-xs uppercase'>
              <tr>
                <th class='p-4 w-16 font-bold'>#</th>
                <th class='p-4 font-bold'>Peleador</th>
                <th class='p-4 text-right font-bold'>Récord</th>
                <th class='p-4'></th>
              </tr>
            </thead>
            <tbody class='divide-y divide-border'>
              {
                ranking.map((fighter) => (
                  <tr class='hover:bg-quimbara-cream/50 transition-colors group'>
                    <td class='p-4 font-bold text-quimbara-purple/60 group-hover:text-quimbara-magenta'>
                      {fighter.rank === 'C' ? (
                        <span class='bg-quimbara-magenta text-black px-2 py-1 rounded font-bold text-xs'>
                          C
                        </span>
                      ) : (
                        `#${fighter.rank}`
                      )}
                    </td>
                    <td class='p-4 font-bold text-quimbara-purple flex items-center gap-3'>
                      <img
                        src={getFighterImg(fighter.id)}
                        alt={fighter.name}
                        class='w-12 h-12 rounded-full bg-quimbara-cream object-cover border border-border'
                        loading='lazy'
                        onerror="this.src='/images/fighter-placeholder.png'"
                      />
                      <span class='group-hover:text-quimbara-magenta transition-colors'>
                        {fighter.name}
                      </span>
                    </td>
                    <td class='p-4 text-right text-quimbara-purple/60 font-mono text-sm'>
                      {fighter.record || '--'}
                    </td>
                    <td class='p-4 text-right'>
                      <a
                        href={`/blog/perfiles-luchadores/${fighter.slug}`}
                        class='text-xs text-quimbara-magenta font-bold uppercase hover:text-[#D63384] transition-colors flex items-center justify-end gap-1'
                      >
                        Ver Perfil →
                      </a>
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <aside class='space-y-6'>
      <!-- Related News -->
      {
        relatedNews.length > 0 && (
          <div class='bg-white p-6 rounded-3xl border border-border shadow-sm'>
            <h3 class='font-heading text-xl mb-4 text-quimbara-purple font-bold'>
              Noticias de la División
            </h3>
            <ul class='space-y-4'>
              {relatedNews.map((post) => (
                <li class='group pb-4 border-b border-border last:border-0 last:pb-0'>
                  <a href={`/blog/${post.id}/`} class='block'>
                    <h4 class='text-sm text-quimbara-purple group-hover:text-quimbara-magenta transition-colors font-medium leading-snug mb-2'>
                      {post.data.title}
                    </h4>
                    <span class='text-xs text-quimbara-purple/50 font-bold uppercase tracking-wider'>
                      Leer más →
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )
      }

      <!-- Context -->
      <div
        class='bg-gradient-to-br from-quimbara-magenta/10 to-quimbara-pink/10 p-6 rounded-3xl border border-quimbara-magenta/20'
      >
        <h3 class='font-heading text-quimbara-magenta text-xl mb-3 font-bold'>Datos de la División</h3>
        <p class='text-sm text-quimbara-purple/70 leading-relaxed mb-4'>
          {divisionInfo.history}
        </p>
        <div class='pt-4 border-t border-quimbara-magenta/20'>
          <p class='text-xs text-quimbara-purple/60 uppercase font-bold mb-1'>Límite de Peso</p>
          <p class='text-quimbara-magenta font-mono font-bold text-lg'>{divisionInfo.limit}</p>
        </div>
      </div>
    </aside>
  </div>

  <!-- Todos los Peleadores de la División -->
  <section class='py-12 border-t border-border'>
    <div class='flex items-center gap-4 mb-8'>
      <div class='h-10 w-2 bg-quimbara-magenta rounded-full'></div>
      <h2 class='text-3xl font-heading font-bold text-quimbara-purple'>Roster Completo</h2>
    </div>
    <p class='text-quimbara-purple/60 mb-8 text-lg'>
      <strong class='text-quimbara-magenta'>{divisionFighters.length}</strong> peleadores activos en la división
      {divisionEs}
    </p>
    <div class='grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4'>
      {
        divisionFighters.map((fighter) => (
          <a
            href={`/blog/perfiles-luchadores/${fighter.slug}`}
            class='group block bg-white rounded-2xl overflow-hidden hover:shadow-lg transition-all duration-300 border border-border hover:border-quimbara-magenta'
          >
            <div class='aspect-square relative overflow-hidden bg-quimbara-cream'>
              <img
                src={getFighterImg(fighter.id)}
                alt={fighter.name}
                class='w-full h-full object-cover object-top group-hover:scale-110 transition-transform duration-500'
                loading='lazy'
                onerror="this.src='/images/fighter-placeholder.png'"
              />
              <div class='absolute inset-0 bg-gradient-to-t from-quimbara-purple via-transparent to-transparent opacity-40 group-hover:opacity-60 transition-opacity' />
            </div>
            <div class='p-3'>
              <h3 class='font-bold text-quimbara-purple group-hover:text-quimbara-magenta transition-colors line-clamp-1 text-sm'>
                {fighter.name}
              </h3>
            </div>
          </a>
        ))
      }
    </div>
  </section>
</PageLayout>
