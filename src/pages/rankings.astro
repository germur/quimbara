---
import { getEntry } from 'astro:content'
import fightersData from '@/data/fighters.json'
import { weightClasses } from '@/data/weightClasses'

import PageLayout from '@/layouts/BaseLayout.astro'
import { getWinStreak } from '@/utils/fighter-stats'

export const prerender = true

// Load all fighter data to find leaders
const allFighters = await Promise.all(
  fightersData.map(async (fighter) => {
    try {
      const entry = await getEntry('fighterData', fighter.id.toString())
      if (!entry?.data) return null

      const fights = entry.data.fights || []

      return {
        ...fighter,
        winStreak: getWinStreak(fights, fighter.id),
        totalWins: entry.data.records?.total.win || 0
      }
    } catch (e) {
      return null
    }
  })
)

const validFighters = allFighters.filter((f): f is NonNullable<typeof f> => f !== null)

// Get leader for each division
const divisionLeaders = weightClasses.map((division) => {
  const divisionFighters = validFighters.filter((f) => f.division === division.name)

  // Sort by Win Streak, then Total Wins
  const leader = divisionFighters.sort((a, b) => {
    if (b.winStreak !== a.winStreak) return b.winStreak - a.winStreak
    return b.totalWins - a.totalWins
  })[0]

  return {
    ...division,
    leader
  }
})

const meta = {
  title: 'Estadísticas por División UFC - Líderes y Datos | Quimbara',
  description:
    'Descubre quiénes lideran cada división de la UFC en rachas ganadoras y victorias. Estadísticas actualizadas de todas las categorías de peso.'
}
---

<PageLayout {meta}>
  <!-- Hero Section -->
  <section class='py-12 mb-12 text-center'>
    <div
      class='inline-block bg-quimbara-magenta/10 text-quimbara-magenta px-4 py-1 rounded-full text-sm font-bold uppercase tracking-wider mb-4 border border-quimbara-magenta/20'
    >
      Basado en Datos Reales
    </div>
    <h1 class='text-4xl md:text-6xl font-heading font-bold mb-4 text-quimbara-purple'>
      LÍDERES POR <span class='text-quimbara-magenta'>DIVISIÓN</span>
    </h1>
    <p class='text-lg text-quimbara-purple/70 max-w-3xl mx-auto leading-relaxed'>
      Olvídate de los rankings subjetivos. Estos son los peleadores que dominan cada categoría
      basándose en sus rachas ganadoras y desempeño actual.
    </p>
  </section>

  <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-20'>
    {
      divisionLeaders.map((item) => (
        <a
          href={`/peleadores/${item.slug}`}
          class='group bg-white rounded-3xl overflow-hidden border border-border shadow-sm hover:shadow-xl transition-all duration-300 hover:-translate-y-1'
        >
          {/* Header */}
          <div class='p-6 bg-quimbara-cream/30 border-b border-border flex justify-between items-center'>
            <h2 class='font-heading font-bold text-quimbara-purple text-xl'>{item.name}</h2>
            <span class='text-xs font-bold text-quimbara-purple/60 uppercase tracking-wider'>
              {item.weight}
            </span>
          </div>

          {/* Leader Content */}
          <div class='p-6'>
            {item.leader ? (
              <div class='flex items-center gap-4'>
                <div class='relative'>
                  <img
                    src={`https://media.api-sports.io/mma/fighters/${item.leader.id}.png`}
                    alt={item.leader.name}
                    class='w-20 h-20 rounded-full object-cover border-2 border-border group-hover:border-quimbara-magenta transition-colors bg-white'
                    loading='lazy'
                  />
                  <div class='absolute -bottom-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full border-2 border-white shadow-sm'>
                    {item.leader.winStreak} W
                  </div>
                </div>

                <div class='flex-1 min-w-0'>
                  <div class='text-xs text-quimbara-magenta font-bold uppercase mb-1'>
                    Líder de Racha
                  </div>
                  <h3 class='font-bold text-quimbara-purple text-lg truncate group-hover:text-quimbara-magenta transition-colors'>
                    {item.leader.name}
                  </h3>
                  <p class='text-quimbara-purple/60 text-sm truncate'>
                    {item.leader.totalWins} victorias totales
                  </p>
                </div>
              </div>
            ) : (
              <div class='flex items-center justify-center h-20 text-quimbara-purple/40 text-sm italic'>
                Sin datos suficientes
              </div>
            )}
          </div>

          {/* Footer */}
          <div class='px-6 py-4 bg-quimbara-purple/5 text-center text-sm font-bold text-quimbara-purple group-hover:bg-quimbara-magenta group-hover:text-white transition-colors'>
            Ver División Completa →
          </div>
        </a>
      ))
    }
  </div>

  <!-- CTA -->
  <section class='py-12 text-center bg-quimbara-purple rounded-3xl relative overflow-hidden'>
    <div class="absolute inset-0 bg-[url('/images/pattern.png')] opacity-10"></div>
    <div class='relative z-10 px-6'>
      <h2 class='text-3xl font-heading font-bold text-white mb-4'>
        ¿Quieres ver más estadísticas?
      </h2>
      <p class='text-white/80 mb-8 max-w-2xl mx-auto'>
        Explora nuestro dashboard completo con récords de finalización, datos físicos y más.
      </p>
      <a
        href='/estadisticas'
        class='inline-block px-8 py-4 bg-white text-quimbara-purple font-bold rounded-xl hover:bg-quimbara-magenta hover:text-white transition-all shadow-lg'
      >
        Ir al Centro de Estadísticas
      </a>
    </div>
  </section>
</PageLayout>
