---
import { getEntry } from 'astro:content'
import fightersData from '@/data/fighters.json'

import PageLayout from '@/layouts/BaseLayout.astro'
import { getFightsInLastMonths, getFinishRate, getWinStreak } from '@/utils/fighter-stats'

export const prerender = true

// Load all fighter data
const allFighters = await Promise.all(
  fightersData.map(async (fighter) => {
    try {
      const entry = await getEntry('fighterData', fighter.id.toString())
      if (!entry?.data) return null

      const records = entry.data.records
      const fights = entry.data.fights || []
      const profile = entry.data.profile

      return {
        ...fighter,
        records,
        fights,
        profile,
        // Pre-calculate stats
        winStreak: getWinStreak(fights, fighter.id),
        finishStats: records ? getFinishRate(records) : { finishRate: 0, koRate: 0, subRate: 0 },
        fightsLastYear: getFightsInLastMonths(fights, 12),
        age: (profile as any)?.age || 0,
        height: profile?.height ? parseInt(profile.height.replace(/\D/g, '')) : 0, // Extract cm
        reach: profile?.reach ? parseInt(profile.reach.replace(/\D/g, '')) : 0 // Extract cm
      }
    } catch (e) {
      return null
    }
  })
)

const validFighters = allFighters.filter((f): f is NonNullable<typeof f> => f !== null)

// --- STATS CALCULATIONS ---

// 1. Longest Win Streaks (Active)
const topWinStreaks = validFighters
  .filter((f) => f.winStreak >= 5)
  .sort((a, b) => b.winStreak - a.winStreak)
  .slice(0, 10)

// 2. Finish Machines (High Finish Rate + Min 10 Wins)
const topFinishers = validFighters
  .filter((f) => f.records && f.records.total.win >= 10)
  .sort((a, b) => b.finishStats.finishRate - a.finishStats.finishRate)
  .slice(0, 10)

// 3. Most Active (Last 12 Months)
const mostActive = validFighters
  .filter((f) => f.fightsLastYear > 0)
  .sort((a, b) => b.fightsLastYear - a.fightsLastYear)
  .slice(0, 10)

// 4. Physical Extremes
const tallest = validFighters
  .filter((f) => f.height > 0)
  .sort((a, b) => b.height - a.height)
  .slice(0, 5)

const longestReach = validFighters
  .filter((f) => f.reach > 0)
  .sort((a, b) => b.reach - a.reach)
  .slice(0, 5)

// 5. Age Records (Active only, min 1 fight last 2 years)
const activeFighters = validFighters.filter((f) => getFightsInLastMonths(f.fights, 24) > 0)

const youngest = activeFighters
  .filter((f) => f.age > 0 && f.age < 25)
  .sort((a, b) => a.age - b.age)
  .slice(0, 5)

const oldest = activeFighters
  .filter((f) => f.age > 0)
  .sort((a, b) => b.age - a.age)
  .slice(0, 5)

const meta = {
  title: 'Estad√≠sticas UFC - R√©cords y Datos Curiosos | Quimbara',
  description:
    'Centro de estad√≠sticas de UFC: rachas ganadoras, finalizadores, r√©cords f√≠sicos y datos curiosos de todos los peleadores activos.'
}
---

<PageLayout meta={meta}>
  <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12'>
    <!-- Header -->
    <div class='text-center mb-16'>
      <h1 class='text-5xl md:text-6xl font-heading font-black text-quimbara-purple mb-4'>
        CENTRO DE <span class='text-quimbara-magenta'>ESTAD√çSTICAS</span>
      </h1>
      <p class='text-xl text-quimbara-purple/70 max-w-2xl mx-auto'>
        An√°lisis profundo de nuestra base de datos de {validFighters.length} peleadores activos. Descubre
        qui√©nes dominan los n√∫meros.
      </p>
    </div>

    <!-- Top Stats Grid -->
    <div class='grid grid-cols-1 lg:grid-cols-3 gap-8 mb-20'>
      <!-- Win Streaks -->
      <div
        class='bg-white rounded-3xl border border-border p-8 shadow-sm hover:shadow-md transition-all'
      >
        <div class='flex items-center gap-3 mb-6'>
          <div
            class='w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-bold text-xl'
          >
            üî•
          </div>
          <h2 class='text-2xl font-heading font-bold text-quimbara-purple'>Rachas Activas</h2>
        </div>
        <div class='space-y-4'>
          {
            topWinStreaks.slice(0, 5).map((f, i) => (
              <a href={`/peleadores/${f.slug}`} class='flex items-center gap-4 group'>
                <div class='font-heading font-black text-3xl text-quimbara-purple/20 w-8'>
                  {i + 1}
                </div>
                <img
                  src={`https://media.api-sports.io/mma/fighters/${f.id}.png`}
                  alt={f.name}
                  class='w-12 h-12 rounded-full object-cover border border-border group-hover:border-quimbara-magenta transition-colors'
                  loading='lazy'
                />
                <div class='flex-1'>
                  <div class='font-bold text-quimbara-purple group-hover:text-quimbara-magenta transition-colors'>
                    {f.name}
                  </div>
                  <div class='text-xs text-quimbara-purple/60'>{f.division}</div>
                </div>
                <div class='font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm'>
                  {f.winStreak} W
                </div>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Finish Rates -->
      <div
        class='bg-white rounded-3xl border border-border p-8 shadow-sm hover:shadow-md transition-all'
      >
        <div class='flex items-center gap-3 mb-6'>
          <div
            class='w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-bold text-xl'
          >
            üí•
          </div>
          <h2 class='text-2xl font-heading font-bold text-quimbara-purple'>Finalizadores</h2>
        </div>
        <div class='space-y-4'>
          {
            topFinishers.slice(0, 5).map((f, i) => (
              <a href={`/peleadores/${f.slug}`} class='flex items-center gap-4 group'>
                <div class='font-heading font-black text-3xl text-quimbara-purple/20 w-8'>
                  {i + 1}
                </div>
                <img
                  src={`https://media.api-sports.io/mma/fighters/${f.id}.png`}
                  alt={f.name}
                  class='w-12 h-12 rounded-full object-cover border border-border group-hover:border-quimbara-magenta transition-colors'
                  loading='lazy'
                />
                <div class='flex-1'>
                  <div class='font-bold text-quimbara-purple group-hover:text-quimbara-magenta transition-colors'>
                    {f.name}
                  </div>
                  <div class='text-xs text-quimbara-purple/60'>
                    {f.records?.total.win} victorias
                  </div>
                </div>
                <div class='font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full text-sm'>
                  {f.finishStats.finishRate}%
                </div>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Most Active -->
      <div
        class='bg-white rounded-3xl border border-border p-8 shadow-sm hover:shadow-md transition-all'
      >
        <div class='flex items-center gap-3 mb-6'>
          <div
            class='w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xl'
          >
            ‚ö°
          </div>
          <h2 class='text-2xl font-heading font-bold text-quimbara-purple'>M√°s Activos</h2>
        </div>
        <div class='space-y-4'>
          {
            mostActive.slice(0, 5).map((f, i) => (
              <a href={`/peleadores/${f.slug}`} class='flex items-center gap-4 group'>
                <div class='font-heading font-black text-3xl text-quimbara-purple/20 w-8'>
                  {i + 1}
                </div>
                <img
                  src={`https://media.api-sports.io/mma/fighters/${f.id}.png`}
                  alt={f.name}
                  class='w-12 h-12 rounded-full object-cover border border-border group-hover:border-quimbara-magenta transition-colors'
                  loading='lazy'
                />
                <div class='flex-1'>
                  <div class='font-bold text-quimbara-purple group-hover:text-quimbara-magenta transition-colors'>
                    {f.name}
                  </div>
                  <div class='text-xs text-quimbara-purple/60'>{f.division}</div>
                </div>
                <div class='font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-sm'>
                  {f.fightsLastYear} peleas
                </div>
              </a>
            ))
          }
        </div>
      </div>
    </div>

    <!-- Physical & Age Grid -->
    <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-20'>
      <!-- Tallest -->
      <div class='bg-quimbara-cream/30 rounded-2xl p-6 border border-border'>
        <h3 class='font-bold text-quimbara-purple mb-4 flex items-center gap-2'>
          <span>üìè</span> Los M√°s Altos
        </h3>
        <div class='space-y-3'>
          {
            tallest.map((f) => (
              <a
                href={`/peleadores/${f.slug}`}
                class='flex justify-between items-center text-sm group'
              >
                <span class='text-quimbara-purple/80 group-hover:text-quimbara-magenta'>
                  {f.name}
                </span>
                <span class='font-bold'>{f.profile?.height}</span>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Longest Reach -->
      <div class='bg-quimbara-cream/30 rounded-2xl p-6 border border-border'>
        <h3 class='font-bold text-quimbara-purple mb-4 flex items-center gap-2'>
          <span>ü¶ç</span> Mayor Alcance
        </h3>
        <div class='space-y-3'>
          {
            longestReach.map((f) => (
              <a
                href={`/peleadores/${f.slug}`}
                class='flex justify-between items-center text-sm group'
              >
                <span class='text-quimbara-purple/80 group-hover:text-quimbara-magenta'>
                  {f.name}
                </span>
                <span class='font-bold'>{f.profile?.reach}</span>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Youngest -->
      <div class='bg-quimbara-cream/30 rounded-2xl p-6 border border-border'>
        <h3 class='font-bold text-quimbara-purple mb-4 flex items-center gap-2'>
          <span>üë∂</span> M√°s J√≥venes
        </h3>
        <div class='space-y-3'>
          {
            youngest.map((f) => (
              <a
                href={`/peleadores/${f.slug}`}
                class='flex justify-between items-center text-sm group'
              >
                <span class='text-quimbara-purple/80 group-hover:text-quimbara-magenta'>
                  {f.name}
                </span>
                <span class='font-bold'>{f.age} a√±os</span>
              </a>
            ))
          }
        </div>
      </div>

      <!-- Oldest -->
      <div class='bg-quimbara-cream/30 rounded-2xl p-6 border border-border'>
        <h3 class='font-bold text-quimbara-purple mb-4 flex items-center gap-2'>
          <span>üë¥</span> Veteranos Activos
        </h3>
        <div class='space-y-3'>
          {
            oldest.map((f) => (
              <a
                href={`/peleadores/${f.slug}`}
                class='flex justify-between items-center text-sm group'
              >
                <span class='text-quimbara-purple/80 group-hover:text-quimbara-magenta'>
                  {f.name}
                </span>
                <span class='font-bold'>{f.age} a√±os</span>
              </a>
            ))
          }
        </div>
      </div>
    </div>

    <!-- HISTORICAL RECORDS SECTION -->
    <div class='mt-24 mb-16'>
      <div class='text-center mb-12'>
        <h2 class='text-5xl md:text-6xl font-heading font-black text-quimbara-purple mb-4'>
          LEYENDAS DEL <span class='text-quimbara-magenta'>OCT√ÅGONO</span>
        </h2>
        <p class='text-xl text-quimbara-purple/70 max-w-3xl mx-auto'>
          R√©cords hist√≥ricos que definen a los mejores peleadores de artes marciales mixtas. Desde
          el poder devastador hasta la precisi√≥n t√©cnica.
        </p>
      </div>

      <!-- SECTION 1: THE FINISHERS -->
      <section class='mb-20'>
        <div class='mb-8 border-l-4 border-quimbara-magenta pl-4'>
          <h3 class='text-4xl font-heading font-bold text-quimbara-purple uppercase'>
            Los Finalizadores
          </h3>
          <p class='text-lg text-quimbara-purple/60 mt-2'>
            Estos atletas buscan terminar la pelea antes que suene la campana final. Los reyes del
            caos: artistas del Nocaut y la Sumisi√≥n.
          </p>
        </div>

        <div class='grid grid-cols-1 md:grid-cols-2 gap-8'>
          <!-- Chart 1: Most Knockouts -->
          <div class='bg-white rounded-3xl shadow-sm border border-border p-8'>
            <h4
              class='text-2xl font-heading font-bold text-quimbara-purple mb-2 flex items-center gap-2'
            >
              <span class='text-3xl'>üëä</span> Reyes del KO
            </h4>
            <p class='text-sm text-quimbara-purple/60 mb-6'>
              Derrick Lewis posee el r√©cord absoluto de m√°s nocauts en la historia de la UFC. Esta
              gr√°fica compara a los golpeadores m√°s letales.
            </p>
            <div class='relative h-80'>
              <canvas id='koChart'></canvas>
            </div>
          </div>

          <!-- Chart 2: Submission Specialists -->
          <div class='bg-white rounded-3xl shadow-sm border border-border p-8'>
            <h4
              class='text-2xl font-heading font-bold text-quimbara-purple mb-2 flex items-center gap-2'
            >
              <span class='text-3xl'>üêç</span> El Rey de la Sumisi√≥n
            </h4>
            <p class='text-sm text-quimbara-purple/60 mb-6'>
              Charles "Do Bronx" Oliveira tiene el r√©cord de sumisiones y finalizaciones totales.
              Desglose de su arsenal letal.
            </p>
            <div class='relative h-80'>
              <canvas id='subChart'></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- SECTION 2: DOMINANCE & CHAMPIONS -->
      <section class='bg-quimbara-cream/30 p-8 rounded-3xl shadow-inner mb-20'>
        <div class='mb-8 text-center'>
          <h3 class='text-4xl font-heading font-bold text-quimbara-purple uppercase'>
            Dinast√≠as y Defensas
          </h3>
          <p class='text-lg text-quimbara-purple/60 mt-2 max-w-3xl mx-auto'>
            Ganar el cintur√≥n es dif√≠cil; mantenerlo es legendario. Reinados que duraron a√±os.
          </p>
        </div>

        <div class='grid grid-cols-1 lg:grid-cols-3 gap-8'>
          <!-- Text Card -->
          <div
            class='bg-quimbara-purple text-white rounded-3xl p-6 flex flex-col justify-center items-center text-center shadow-lg lg:col-span-1'
          >
            <div class='text-6xl mb-4'>üëë</div>
            <h4 class='text-3xl font-heading font-bold mb-4'>El Club de los 11</h4>
            <p class='text-white/90 text-sm'>
              Solo dos hombres comparten la cima con 11 defensas consecutivas del t√≠tulo
              indiscutido. Consistencia mental y f√≠sica inigualable.
            </p>
            <div class='mt-6 border-t border-white/20 pt-4 w-full'>
              <div class='flex justify-between items-center mb-2'>
                <span class='font-bold'>Jon Jones</span>
                <span class='text-quimbara-pink font-heading text-2xl'>11 Def.</span>
              </div>
              <div class='flex justify-between items-center'>
                <span class='font-bold'>D. Johnson</span>
                <span class='text-quimbara-pink font-heading text-2xl'>11 Def.</span>
              </div>
            </div>
          </div>

          <!-- Chart 3: Title Defenses -->
          <div class='bg-white rounded-3xl shadow-sm border border-border p-8 lg:col-span-2'>
            <h4 class='text-2xl font-heading font-bold text-quimbara-purple mb-2'>
              Defensas de T√≠tulo Consecutivas
            </h4>
            <p class='text-sm text-quimbara-purple/60 mb-6'>
              Comparativa hist√≥rica de las rachas de campeonato m√°s largas en la UFC.
            </p>
            <div class='relative h-80'>
              <canvas id='defenseChart'></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- SECTION 3: QUICK STATS GRID -->
      <section class='mb-12'>
        <div class='mb-6 text-center'>
          <h3 class='text-4xl font-heading font-bold text-quimbara-purple uppercase'>
            Datos Rel√°mpago
          </h3>
        </div>
        <div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4'>
          <!-- Stat 1 -->
          <div
            class='bg-quimbara-purple text-white p-6 rounded-3xl text-center border-t-4 border-quimbara-magenta'
          >
            <div class='text-4xl mb-2'>‚è±Ô∏è 5s</div>
            <div class='font-heading text-xl text-white/70'>KO M√°s R√°pido</div>
            <div class='font-bold text-lg mt-1'>Jorge Masvidal</div>
            <div class='text-xs text-white/60'>vs Ben Askren</div>
          </div>
          <!-- Stat 2 -->
          <div
            class='bg-quimbara-purple text-white p-6 rounded-3xl text-center border-t-4 border-quimbara-magenta'
          >
            <div class='text-4xl mb-2'>ü•ã 90</div>
            <div class='font-heading text-xl text-white/70'>M√°s Derribos</div>
            <div class='font-bold text-lg mt-1'>GSP</div>
            <div class='text-xs text-white/60'>Georges St-Pierre</div>
          </div>
          <!-- Stat 3 -->
          <div
            class='bg-quimbara-purple text-white p-6 rounded-3xl text-center border-t-4 border-quimbara-magenta'
          >
            <div class='text-4xl mb-2'>ü©∏ 16</div>
            <div class='font-heading text-xl text-white/70'>Racha de Victorias</div>
            <div class='font-bold text-lg mt-1'>Anderson Silva</div>
            <div class='text-xs text-white/60'>Peso Medio</div>
          </div>
          <!-- Stat 4 -->
          <div
            class='bg-quimbara-purple text-white p-6 rounded-3xl text-center border-t-4 border-quimbara-magenta'
          >
            <div class='text-4xl mb-2'>üèüÔ∏è 42+</div>
            <div class='font-heading text-xl text-white/70'>M√°s Peleas</div>
            <div class='font-bold text-lg mt-1'>Jim Miller</div>
            <div class='text-xs text-white/60'>Longevidad Pura</div>
          </div>
        </div>
      </section>
    </div>

    <!-- CTA -->
    <div class='text-center'>
      <a
        href='/peleadores'
        class='inline-flex items-center justify-center px-8 py-4 text-base font-bold text-white transition-all duration-200 bg-quimbara-magenta rounded-xl hover:bg-quimbara-purple hover:shadow-lg hover:-translate-y-1'
      >
        Explorar Todos los Peleadores
      </a>
    </div>
  </div>

  <!-- Chart.js Script -->
  <script is:inline src='https://cdn.jsdelivr.net/npm/chart.js'></script>
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function () {
      // Utility: Split long labels
      function splitLabel(label) {
        if (label.length <= 16) return label
        const words = label.split(' ')
        const lines = []
        let currentLine = words[0]
        for (let i = 1; i < words.length; i++) {
          if ((currentLine + ' ' + words[i]).length < 16) {
            currentLine += ' ' + words[i]
          } else {
            lines.push(currentLine)
            currentLine = words[i]
          }
        }
        lines.push(currentLine)
        return lines
      }

      // Common tooltip options
      const commonTooltipOptions = {
        callbacks: {
          title: function (tooltipItems) {
            const item = tooltipItems[0]
            let label = item.chart.data.labels[item.dataIndex]
            return Array.isArray(label) ? label.join(' ') : label
          }
        }
      }

      // CHART 1: KO KINGS (Horizontal Bar)
      const koCtx = document.getElementById('koChart').getContext('2d')
      const koLabels = [
        'Derrick Lewis',
        'Matt Brown',
        'Chris Leben',
        'Vitor Belfort',
        'Anthony Johnson'
      ]
      const processedKoLabels = koLabels.map(splitLabel)

      new Chart(koCtx, {
        type: 'bar',
        data: {
          labels: processedKoLabels,
          datasets: [
            {
              label: 'Nocauts (KO/TKO)',
              data: [15, 13, 12, 12, 11],
              backgroundColor: '#E83C91', // quimbara-magenta
              borderColor: '#43334C', // quimbara-purple
              borderWidth: 1,
              barPercentage: 0.6
            }
          ]
        },
        options: {
          indexAxis: 'y',
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: commonTooltipOptions
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: '#e5e7eb' }
            },
            y: {
              grid: { display: false }
            }
          }
        }
      })

      // CHART 2: SUBMISSION SPECIALIST (Doughnut)
      const subCtx = document.getElementById('subChart').getContext('2d')
      const subLabels = ['Mata Le√≥n', 'Guillotina', 'Tri√°ngulo', 'Palmera', 'Anaconda']
      const processedSubLabels = subLabels.map(splitLabel)

      new Chart(subCtx, {
        type: 'doughnut',
        data: {
          labels: processedSubLabels,
          datasets: [
            {
              label: 'Tipo de Sumisi√≥n',
              data: [9, 3, 2, 1, 1],
              backgroundColor: [
                '#E83C91', // magenta
                '#43334C', // purple
                '#FF8FB7', // pink
                '#6B7280', // grey
                '#F8F4EC' // cream
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 15, font: { size: 11 } }
            },
            tooltip: commonTooltipOptions
          }
        }
      })

      // CHART 3: TITLE DEFENSES (Vertical Bar)
      const defCtx = document.getElementById('defenseChart').getContext('2d')
      const defLabels = ['Jon Jones', 'D. Johnson', 'A. Silva', 'GSP', 'A. Nunes']
      const processedDefLabels = defLabels.map(splitLabel)

      new Chart(defCtx, {
        type: 'bar',
        data: {
          labels: processedDefLabels,
          datasets: [
            {
              label: 'Defensas de T√≠tulo',
              data: [11, 11, 10, 9, 7],
              backgroundColor: '#FF8FB7', // quimbara-pink for champions
              borderRadius: 6
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: commonTooltipOptions
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#e5e7eb' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      })
    })
  </script>
</PageLayout>
